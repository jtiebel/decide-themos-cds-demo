<!doctypehtml><html lang=de><meta charset=UTF-8><meta content="width=device-width,initial-scale=1"name=viewport><title>KIS Patientensicht</title><link href=https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css rel=stylesheet><style>.console-wrapper h5,footer{padding:1rem}.card-title,.screen-warning,.section-header{font-weight:700}:root{--console-timestamp-color:lightgreen;--console-key-color:goldenrod;--console-value-color:white}::-webkit-scrollbar{width:6px;height:6px}::-webkit-scrollbar-track{background:0 0}::-webkit-scrollbar-thumb{background-color:rgba(0,0,0,.2);border-radius:3px;border:none}*{scrollbar-width:thin;scrollbar-color:rgba(0,0,0,.2) transparent}#console>pre{margin-left:1rem}body,html{margin:0;padding:0;height:100vh;display:flex;font-family:Arial,sans-serif;width:100%;overflow:hidden;font-size:16px}p{margin-top:0;margin-bottom:.5rem}.screen-warning{display:none;position:fixed;z-index:9999;top:0;left:0;width:100vw;height:100vh;background-color:rgba(0,0,0,.85);color:#fff;font-size:1rem;align-items:center;justify-content:center;text-align:center;padding:2rem}.app__wrapper,footer{background-color:#f1f4f6}.app__wrapper{flex:0 0 66.66%;padding:0;display:flex;flex-direction:column;max-width:calc(66.66% - .7rem);min-width:66.66%;overflow-y:scroll}.console-wrapper{flex:0 0 33.33%;max-height:100vh;background-color:#1e1e1e;color:#d4d4d4;font-family:monospace;font-size:.9rem;padding-right:0;min-width:33.33%;max-width:33.33%}.card-text,.console-header,.console-link,footer{font-size:.8rem}.console-entry{overflow-x:auto;margin:1rem}.app-header{background-color:#004080;color:#fff;padding:1rem 2rem;border-bottom:3px solid #036;position:sticky;top:0;z-index:9}.section-header{background-color:#e9ecef;padding:.5rem 1rem;border-left:4px solid #004080}.card{border-radius:.25rem;box-shadow:0 0 5px rgba(0,0,0,.1);margin:1rem;cursor:pointer}.card.active{border:2px solid #007bff}.console-header{color:var(--console-timestamp-color)}.console-box{max-height:calc(100vh - 4rem);white-space:pre-wrap;overflow-y:scroll}.console-box pre{font-family:monospace;margin-bottom:1rem;padding-left:.2rem}.console-key,.console-link span{color:var(--console-key-color)}.console-boolean,.console-null,.console-number,.console-string{color:var(--console-value-color)}.console-link{display:inline-block;white-space:nowrap;margin:.5rem}.console-link .link{padding-left:1rem}.console-link .wrap{color:#d4d4d4}.console-link a{color:#fff}.recommendation-box{border-left:4px solid #198754;padding-left:1rem;margin-bottom:1rem}footer{margin-top:auto;color:#666;text-align:center}#goal-summar button,.plan-button{margin-top:.5rem}.modal{width:66.66%}.modal *{--bs-modal-width:90%;max-width:800px}.modal-backdrop{width:66.66vw}.goal-setting{margin-left:5rem}#btn-open-goal-modal,#goal-summary{margin-left:3.4rem}#btn-complete-planning{margin-left:1rem;width:fit-content}.text-info{color:#000!important}#modalRecommendationsContainer .card{margin-left:0;margin-right:0}.modal-body,.modal-footer,.modal-header{padding-left:2rem;padding-right:2rem}.toast-container{right:33.33%!important}.card-body .badge{margin:.5rem 0 .3rem!important;border-radius:0}</style><div class=screen-warning id=screen-warning>Die Mindestbildschirmgröße von 800×600 px ist unterschritten. Bitte Fenster vergrößern oder auf einem größeren Gerät öffnen.</div><div class=app__wrapper><div class="align-items-center app-header d-flex justify-content-start"><h5 class=mb-0>EHR Umgebung – CDS-basierte Therapieplanung</h5></div><div class=card><div class=section-header>Stammdaten</div><div class=card-body id=patient-info></div></div><div class=card><div class=section-header>Klinische Informationen</div><div class=card-body><div id=diagnosis-stroke-info></div><div id=observations-info></div><div id=diagnosis-abnormal-gait-info></div></div></div><div class=card><div class=section-header>Rehabilitationsmaßnahmen | Status: <span id=goals-info style=color:red>in Planung</span></div><div class=card-body><div class=mb-3><h6><b>Verordnete Prozeduren:</b></h6><div id=service-requests-info></div></div><div id=goal-container><div id=goal-summary></div><button class="btn btn-primary"type=button id=btn-open-goal-modal>Therapieziel hinzufügen</button></div></div></div><button class="btn btn-success d-none mt-3"type=button id=btn-complete-planning>Therapieplanung abschließen</button><footer>DECIDE: TheMoS FHIR-based Guideline CDS Implementation | Demo Version 1.45</footer></div><div class=console-wrapper><h5 class=text-white style=padding-bottom:.7rem>FHIR-API-Kommunikation</h5><div class=console-box id=console><pre>Warte auf FHIR-Daten …</pre></div></div><div class="bottom-0 end-0 p-3 position-fixed toast-container"><div class="align-items-center border-0 text-bg-success toast"id=goalToast aria-atomic=true aria-live=assertive role=alert><div class=d-flex><div class=toast-body>Das Ziel wurde erfolgreich übernommen.</div><button class="btn-close btn-close-white m-auto me-2"type=button data-bs-dismiss=toast aria-label=Schließen></button></div></div><div class="align-items-center border-0 text-bg-success toast mt-2"id=interventionToast aria-atomic=true aria-live=assertive role=alert><div class=d-flex><div class=toast-body>Die Intervention wurde erfolgreich übernommen.</div><button class="btn-close btn-close-white m-auto me-2"type=button data-bs-dismiss=toast aria-label=Schließen></button></div></div><div class="align-items-center border-0 text-bg-success toast mt-2"id=completePlanningToast aria-atomic=true aria-live=assertive role=alert><div class=d-flex><div class=toast-body>Die Therapieplanung wurde erfolgreich abgeschlossen.</div><button class="btn-close btn-close-white m-auto me-2"type=button data-bs-dismiss=toast aria-label=Schließen></button></div></div></div><div class="fade modal"id=goalSettingModal aria-hidden=true aria-labelledby=goalSettingModalLabel tabindex=-1><div class=modal-dialog><div class=modal-content><div class=modal-header><h5 class=modal-title id=goalSettingModalLabel>Zielsetzung für das Gangtraining</h5><button class=btn-close type=button data-bs-dismiss=modal aria-label=Schließen></button></div><div class=modal-body><p class=mb-3>Basierend auf der aktuellen Konstellation (Schlaganfall, Gangstörung, Gangtraining) schlägt die Leitlinie zur Therapie der Mobilität folgende Zielkriterien vor. Bitte wählen Sie geeignete Ziele aus.<div class=mb-3><label class=form-label for=modal-rehaziel>Zielsetzung wählen:</label> <select class=form-select id=modal-rehaziel><option value="">Zielsetzung für das Gangtraining wählen:<option value=282097004 data-description="Individuelle Zielbeschreibung"data-display="Verbesserung der Gehfähigkeit"data-name="Ability to walk"data-url=Condition/condition>Verbesserung der Gehfähigkeit (282097004)</select></div><div class=mb-3><label class=form-label for=modal-ziel-description>Zielformulierung:</label> <input class=form-control id=modal-ziel-description></div></div><div class=modal-footer><button class="btn btn-secondary"type=button data-bs-dismiss=modal>Abbrechen</button> <button class="btn btn-primary"type=button id=modal-btn-accept-goal>Übernehmen</button></div></div></div></div><div class="fade modal"id=guidelineModal aria-hidden=true aria-labelledby=guidelineModalLabel tabindex=-1><div class=modal-dialog><form id=guidelineForm><div class=modal-content><div class=modal-header><h5 class=modal-title id=guidelineModalLabel>Clinical Decision Support System (CDSS)</h5></div><div class=modal-body><div class="mb-2 text-info"id=interventionCount></div><div class=mb-3 id=modalRecommendationsContainer></div><div class="mb-3 d-none"id=modalPlanForm><div class=mb-2><label class=form-label for=freqInputModal>Einheiten pro Woche:</label> <input class=form-control id=freqInputModal max=10 min=1 placeholder=2 required type=number value=2></div><div class=mb-2><label class=form-label for=durInputModal>Minuten pro Einheit:</label> <input class=form-control id=durInputModal max=120 min=15 placeholder=30 required type=number value=30 step=15></div></div></div><div class=modal-footer><button class="btn btn-secondary"type=button data-bs-dismiss=modal>Abbrechen</button> <button class="btn btn-success"type=submit id=btnConfirmGuideline disabled>Übernehmen</button></div></div></form></div></div><script src=https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js></script><script>const syntaxHighlight=e=>("string"!=typeof e&&(e=JSON.stringify(e,null,2)),e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|\d+)/g,(e=>`<span class="${/^"/.test(e)?/:$/.test(e)?"console-key":"console-string":/true|false/.test(e)?"console-boolean":/null/.test(e)?"console-null":"console-number"}">${e}</span>`)));function logToConsole(e,t,n={}){let o=(new Date).toLocaleTimeString(),i=document.createElement("div");i.classList.add("console-entry");let a=document.createElement("div");if(a.classList.add("console-header"),a.textContent=`[${o}] ${e}:`,i.appendChild(a),n.source){let e=document.createElement("div");e.classList.add("console-link"),e.innerHTML=`<div class="wrap">{</div>\n                         <div class="link"><span>"source":</span> "${n.source}"</div>\n                         <div class="wrap">}</div>`,i.appendChild(e),delete n.source}if(!n.hideData){let e=document.createElement("pre");e.classList.add("highlight"),e.innerHTML=syntaxHighlight(t),i.appendChild(e)}if(Object.keys(n).length>0&&!n.hideData){let e=document.createElement("pre");e.classList.add("highlight"),e.innerHTML=`Zusätzliche Details:\n${syntaxHighlight(n)}`,i.appendChild(e)}document.getElementById("console").appendChild(i),setTimeout((()=>{document.getElementById("console").scrollTop=document.getElementById("console").scrollHeight}),10)}function updatePatientInfo(e){document.getElementById("patient-info").innerHTML=`\n    <p><strong>Name:</strong> ${e.name[0].given[0]} ${e.name[0].family}</p>\n    <p><strong>Geburtsdatum:</strong> ${e.birthDate}</p>\n    <p><strong>Geschlecht:</strong> ${"female"===e.gender?"weiblich":e.gender}</p>\n  `}function updateConditions(e,t){if(e){let{code:{coding:[n]}}=e;document.getElementById(t).innerHTML=`<p><strong>Diagnose:</strong> Hirninfarkt (<a href="https://www.icd10data.com/ICD10CM/Codes/I00-I99/I60-I69/I63-/I63.3" target="_blank">${n.code} ${n.display}</a>)</p>`}}function updateAbnormalGaitInfo(e){if(e){let{code:{coding:[t]}}=e;document.getElementById("diagnosis-abnormal-gait-info").innerHTML=`\n      <p>\n        <strong>Klinischer Befund:</strong> Gangstörung\n        (<a href="https://browser.ihtsdotools.org/?perspective=full&amp;conceptId1=${t.code}&amp;edition=MAIN/2025-04-01&amp;release=&amp;languages=en" target="_blank">${t.code} ${t.display}</a>)\n      </p>\n    `}}function updateObservations(e){if(!e||0===e.length)return;let t=e.map((e=>{let{coding:[t]}=e.code;return`<p><strong>${t.display}:</strong> ${e.valueInteger??(e.valueString||"kein Wert")}</p>`})).join("");document.getElementById("observations-info").innerHTML=`<div>${t}</div>`}function updateServiceRequests(e){if(!e||0===e.length)return;let t="";e.forEach((e=>{let{coding:[n]}=e.code,o=`https://browser.ihtsdotools.org/?perspective=full&conceptId1=${n.code}&edition=MAIN/2025-04-01&release=&languages=en`;"servicerequest-physiotherapy-training"===e.id?t+=`<p><span>Physiotherapie Training</span> (<a href="${o}" target="_blank">${n.code} ${n.display}</a>)</p>`:"servicerequest-ambulation-training"===e.id?t+=`<p><span>└─</span> Mobilitätstraining (<a href="${o}" target="_blank">${n.code} ${n.display}</a>)</p>`:("servicerequest-gait-training"===e.id||"servicerequest-gait-reeducation"===e.id)&&(t+=`<p><span style="margin-left:25px">└─</span> Gangtraining (<a href="${o}" target="_blank">${n.code} ${n.display}</a>)</p>`)})),document.getElementById("service-requests-info").innerHTML=t}async function loadJSON(e){try{let t=await fetch(e),n=`<a href="${e}" target="_blank">${e}</a>`;if(logToConsole("FHIR API Response",{resourceType:"Bundle",status:t.status,ok:t.ok}),!t.ok)throw Error(`HTTP-Fehler: ${t.status}`);let o=await t.json();return logToConsole("FHIR Bundle Loaded",{resourceType:o.resourceType,type:o.type},{source:n,hideData:!0}),o}catch(e){throw logToConsole("Fehler beim Laden der JSON-Daten",{error:e.message}),e}}async function loadCDSHookLibrary(){try{let e=await fetch("https://raw.githubusercontent.com/jtiebel/decide-themos-cds-demo/main/resources/goalset-cds-hook-library.json");if(!e.ok)throw Error(`HTTP-Fehler beim Laden der CDS Library: ${e.status}`);let t=await e.json();return logToConsole("Goalset CDS Hook Loaded",t),t}catch(e){throw logToConsole("Fehler beim Laden der CDS Hook Library",{error:e.message}),e}}async function loadRecommendationCDSHookLibrary(){try{let e=await fetch("https://raw.githubusercontent.com/jtiebel/decide-themos-cds-demo/main/resources/recommendation-cds-hook-library.json");if(!e.ok)throw Error(`HTTP-Fehler beim Laden der Recommendation CDS Library: ${e.status}`);let t=await e.json();return logToConsole("Recommendation CDS Hook Loaded",t),logToConsole("Recommendation CDS Hook Started",{message:"Check for matches against the guideline."}),t}catch(e){throw logToConsole("Error",{error:e.message}),e}}async function evaluateTriggerGoalset(e){try{await loadCDSHookLibrary(),logToConsole("Goalset CDS Hook Started",{message:"Check for matches against the guideline."})}catch(e){logToConsole("Error",{error:e.message})}let t=!1,n=!1,o=!1;return e.entry.forEach((e=>{let{resource:i}=e;"Condition"===i.resourceType&&i.code?.coding&&i.code.coding.forEach((e=>{"http://hl7.org/fhir/sid/icd-10"===e.system&&"I63.3"===e.code&&(t=!0),"http://snomed.info/sct"===e.system&&"22325002"===e.code&&(n=!0)})),"ServiceRequest"===i.resourceType&&i.code?.coding&&i.code.coding.forEach((e=>{"http://snomed.info/sct"===e.system&&"74914000"===e.code&&(o=!0)}))})),logToConsole("Goalset CDS Hook Evaluation",{hasStroke:t,hasAbnormalGait:n,hasGaitServiceRequest:o}),t&&n&&o}function evaluateTriggerGuidelineRecommendation(e,t){let n=!1;return e.entry&&Array.isArray(e.entry)?e.entry.forEach((e=>{let{resource:o}=e;"Goal"===o.resourceType&&Array.isArray(o.target)&&o.target.forEach((e=>{e.measure&&e.measure.coding&&e.measure.coding.forEach((e=>{"http://snomed.info/sct"===e.system&&e.code===t&&(n=!0)}))}))})):e.sections&&Array.isArray(e.sections)&&e.sections.forEach((e=>{e.subSections&&Array.isArray(e.subSections)&&e.subSections.forEach((e=>{e.recommendations&&Array.isArray(e.recommendations)&&e.recommendations.forEach((e=>{e.interventions&&e.interventions.codes&&e.interventions.codes.some((e=>e.code===t))&&(n=!0)}))}))})),n}class TherapyPlanApp{constructor(){this.apiEndpoints={patient:"https://raw.githubusercontent.com/jtiebel/decide-themos-cds-demo/main/resources/patient-example.json",goalsetExample:"https://raw.githubusercontent.com/jtiebel/decide-themos-cds-demo/main/resources/goalset-cds-example.json",recommendationExample:"https://raw.githubusercontent.com/jtiebel/decide-themos-cds-demo/main/resources/recommendation-cds-example.json"},this.currentRecommendation=null,this.currentGoal=null,this.addedGoals=[],this.goalProcedures=[],this.bundle=null,this.guidelineRecs=[],this.goalSettingModal=new bootstrap.Modal(document.getElementById("goalSettingModal")),this.guidelineModal=new bootstrap.Modal(document.getElementById("guidelineModal"))}init(){this.bindEvents(),this.loadPatientData(),window.addEventListener("resize",(()=>this.checkScreenSize())),window.addEventListener("load",(()=>this.checkScreenSize()))}bindEvents(){document.getElementById("btn-open-goal-modal").addEventListener("click",(async()=>{document.getElementById("modal-ziel-description").value="";let e=this.bundle,t=e.entry.find((e=>"Condition"===e.resource.resourceType&&"condition-stroke"===e.resource.id))?.resource,n=e.entry.find((e=>"Condition"===e.resource.resourceType&&"condition-abnormal-gait"===e.resource.id))?.resource,o=e.entry.find((e=>"ServiceRequest"===e.resource.resourceType&&e.resource.code.coding.some((e=>"http://snomed.info/sct"===e.system&&"74914000"===e.code))))?.resource;if(t&&n&&o){logToConsole("Goalset CDS Hook Triggered",{trigger:{conditionStroke:t.code.coding[0],conditionAbnormalGait:n.code.coding[0],serviceRequestGait:o.code.coding[0]},message:"Pass patient conditions and service requests to CDS."});let i=await this.evaluateGoalsetHook(e);if(i){let e=document.getElementById("modal-rehaziel");e.innerHTML='<option value="">Bitte Zielsetzung wählen:</option>',i.entry.forEach((t=>{let n=t.resource;if("Goal"===n.resourceType){let t=n.description&&n.description.coding&&n.description.coding[0],o=n.note&&n.note[0]?n.note[0].text:"";t&&(e.innerHTML+=`\n                  <option value="${t.code}" \n                          data-description="${o}" \n                          data-name="${t.display}" \n                          data-display="${n.description.text}" \n                          data-url="Condition/condition-abnormal-gait">\n                    ${n.description.text} (${t.code})\n                  </option>`)}}))}}else logToConsole("Goalset CDS Hook Trigger fehlgeschlagen",{message:"Nicht alle erforderlichen Trigger-Bedingungen sind erfüllt."});this.goalSettingModal.show()})),document.getElementById("modal-rehaziel").addEventListener("change",(function(){document.getElementById("modal-ziel-description").value=this.options[this.selectedIndex].getAttribute("data-description")||""})),document.getElementById("modal-btn-accept-goal").addEventListener("click",(()=>this.handleModalGoalAccept())),document.getElementById("guidelineForm").addEventListener("submit",(e=>{e.preventDefault(),this.handleGuidelineFormSubmit()})),document.getElementById("btn-complete-planning").addEventListener("click",(()=>this.handlePlanComplete()))}async loadPatientData(){try{this.bundle=await loadJSON(this.apiEndpoints.patient);let e=this.bundle.entry.find((e=>"Patient"===e.resource.resourceType))?.resource;updatePatientInfo(e),logToConsole("FHIR Bundle Patient Extracted",e);let t=e=>this.bundle.entry.filter((t=>t.resource.resourceType===e)).map((e=>e.resource)),n=t("Condition"),o=t("Observation"),i=t("ServiceRequest");n.forEach(((e,t)=>logToConsole(`FHIR Bundle Condition-${t+1} Extracted`,e))),o.forEach(((e,t)=>logToConsole(`FHIR Bundle Observation-${t+1} Extracted`,e))),i.forEach(((e,t)=>logToConsole(`FHIR Bundle ServiceRequest-${t+1} Extracted`,e)));let a=this.bundle.entry.find((e=>"Task"===e.resource.resourceType&&"task-initiate-pt-planning"===e.resource.id))?.resource;a&&logToConsole("FHIR Task Initiate PT Planning",a);let r=n.find((e=>"condition-stroke"===e.id)),s=n.find((e=>"condition-abnormal-gait"===e.id));updateConditions(r,"diagnosis-stroke-info"),updateAbnormalGaitInfo(s),updateObservations(o),updateServiceRequests(i)}catch(e){logToConsole("FHIR Error",{resourceType:"OperationOutcome",issue:[{severity:"error",code:"exception",details:{text:e.message}}]}),alert("Fehler beim Laden der Patientendaten.")}}async evaluateGoalsetHook(e){try{let t=await evaluateTriggerGoalset(e);if(logToConsole("Goalset CDS Hook Result",{triggerResult:t}),!t)return logToConsole("Goalset Evaluation","Kein Trigger – Goalset Example wird nicht geladen."),null;let n=await loadJSON(this.apiEndpoints.goalsetExample),o=n.entry.filter((e=>"Goal"===e.resource.resourceType)).map((e=>e.resource)),i=[{summary:`${o.length} empfohlene Zielkriterien aus der Leitlinie gefunden`,indicator:"info",detail:"Basierend auf der aktuellen Konstellation (Schlaganfall, Gangstörung, Gangtraining) schlägt die Leitlinie folgende Zielkriterien vor. Bitte wählen Sie geeignete Ziele aus.",source:{label:"Goalset CDS Hook Library",url:this.apiEndpoints.goalsetExample},suggestions:o.map((e=>{let t=e.target?.[0]?.measure?.coding?.[0]||{},n=e.description?.text||t.display||"–",o=e.note?.[0]?.text||"";return{label:n,uuid:e.id,actions:[{type:"create",description:o,resource:{resourceType:"Goal",lifecycleStatus:e.lifecycleStatus||"proposed",description:{text:n},target:[{measure:{coding:[{system:t.system||"http://snomed.info/sct",code:t.code||"",display:t.display||n}]}}]}}]}}))}];return logToConsole("FHIR Card Goalset Extracted",{cards:i}),n}catch(e){return logToConsole("evaluateGoalsetHook Error",{error:e.message}),null}}handleModalGoalAccept(){let e=document.getElementById("modal-rehaziel"),t=e.options[e.selectedIndex],n=t.value,o=t.getAttribute("data-name"),i=t.getAttribute("data-description"),a=t.getAttribute("data-display"),r=t.getAttribute("data-url");if(n&&o&&i&&a&&r){let e=document.getElementById("modal-ziel-description").value,t={resourceType:"Goal",id:`goal-${Date.now()}`,lifecycleStatus:"proposed",achievementStatus:{coding:[{system:"http://terminology.hl7.org/CodeSystem/goal-achievement",code:"in-progress",display:"In Progress"}]},description:{text:e},subject:{reference:"Patient/patient-example-erika"},target:[{measure:{coding:[{system:"http://snomed.info/sct",code:n,name:o}]}}],measureName:a};logToConsole("FHIR Goal Resource Selected",t),this.addedGoals.push(t),this.renderGoalList(),this.goalSettingModal.hide(),new bootstrap.Toast(document.getElementById("goalToast")).show()}}renderGoalList(){document.getElementById("goal-summary").innerHTML=this.addedGoals.map(((e,t)=>{let{code:n,display:o}=e.target[0].measure.coding[0];return`<div class="mb-3">\n                <p><strong>Zielkriterium:</strong> ${e.measureName} (<a href="https://browser.ihtsdotools.org/?perspective=full&conceptId1=${n}&edition=MAIN/2025-04-01&release=&languages=en" target="_blank">${n} ${e.target[0].measure.coding[0].name}</a>)</p>\n                <p><strong>Zielformulierung:</strong> ${e.description.text}</p>\n                ${e.intervention?`<p><strong>Intervention:</strong> ${e.intervention.heading}</p>\n           <p><strong>Einheiten pro Woche:</strong> ${e.intervention.frequency}</p>\n           <p><strong>Minuten pro Einheit:</strong> ${e.intervention.duration}</p>`:`<button type="button" class="btn btn-warning btn-plan-therapy" data-index="${t}">Clinical Reasoning starten</button>`}\n                <hr>\n              </div>`})).join(""),this.addedGoals.length&&document.getElementById("btn-complete-planning").classList.remove("d-none"),document.querySelectorAll(".btn-plan-therapy").forEach((e=>e.addEventListener("click",(e=>this.handlePlanTherapy(e.currentTarget.getAttribute("data-index"))))))}async handlePlanTherapy(e){this.currentGoal=this.addedGoals[e],logToConsole("Recommendation CDS Hook triggered",{target:this.currentGoal.target[0].measure.coding[0],user:{role:"Therapist"},message:"Pass intervention goal and user role to CDS."}),await loadRecommendationCDSHookLibrary(),this.runGuidelineCheck(this.currentGoal.target[0].measure.coding[0].code).then((()=>{document.getElementById("modalRecommendationsContainer").classList.remove("d-none"),document.getElementById("modalPlanForm").classList.add("d-none"),document.getElementById("btnConfirmGuideline").disabled=!0,this.displayRecommendationsRadioCards(this.guidelineRecs),this.guidelineModal.show()})).catch((e=>console.error("Fehler beim Laden der Leitlinienempfehlungen",e)))}async runGuidelineCheck(e){try{let t=await loadJSON(this.apiEndpoints.recommendationExample),n=evaluateTriggerGuidelineRecommendation(t,e);if(logToConsole("Recommendation CDS Hook Evaluation",{targetCode:e,found:n}),logToConsole("Recommendation CDS Hook Result",{code:e,triggerResult:n}),!n)return logToConsole("Recommendation CDS Hook Evaluation","No Trigger."),[];{let n=this.extractRecommendations(t,e);return this.guidelineRecs=n,this.guidelineRecs}}catch(e){throw logToConsole("runGuidelineCheck Error",{error:e.message}),e}}extractRecommendations(e,t){let n=[];e.sections&&Array.isArray(e.sections)&&e.sections.forEach((e=>{e.subSections&&Array.isArray(e.subSections)&&e.subSections.forEach((e=>{e.recommendations&&Array.isArray(e.recommendations)&&e.recommendations.forEach((e=>{e.interventions&&e.interventions.codes&&e.interventions.codes.some((e=>e.code===t))&&n.push(e)}))}))}));let o=e=>String(e||"").toLowerCase().replace(/\s+/g,"-"),i={resourceType:"Bundle",type:"collection",entry:n.map((e=>({resourceType:"PlanDefinition",id:`${o(e.heading)}-${o(e.guidelineId)}-${o(e.recommendationId)}`,url:`https://magicapp.org/guidelines/${e.guidelineId}/recommendations/${e.recommendationId}`,version:"1.0.0",title:e.heading,description:e.text,strength:e.strength,status:"active",publisher:"Deutsche Gesellschaft für Neurologische Rehabilitation e.V.",date:(new Date).toISOString(),useContext:[{code:{system:"http://terminology.hl7.org/CodeSystem/usage-context-type",code:"clinical-focus"},valueCodeableConcept:{coding:[{system:"http://snomed.info/sct",code:"22325002",display:"Abnormal gait (finding)"}]}},{code:{system:"http://terminology.hl7.org/CodeSystem/usage-context-type",code:"goal"},valueCodeableConcept:{coding:[{system:"http://snomed.info/sct",code:e.interventions.codes[0].code,display:e.interventions.codes[0].name}]}},{code:{system:"http://terminology.hl7.org/CodeSystem/usage-context-type",code:"procedure"},valueCodeableConcept:{coding:[{system:"http://snomed.info/sct",code:"74914000",display:"Gait re-education (procedure)"}]}}],action:[{title:`${e.heading} starten`,description:"...",textEquivalent:"...",condition:[{kind:"applicability",expression:{language:"text/cql",expression:"HasStroke and HasAbnormalGait and HasGaitServiceRequest"}}],definitionCanonical:`ActivityDefinition/${e.heading}`}]}))).map((e=>({resource:e})))},a={STRONG:"Starke Empfehlung",WEAK:"Schwache Empfehlung",WEAKAGAINST:"Schwache Empfehlung Gegen"};return logToConsole("FHIR Recommendations Card",{guidelineRecommendationsCard:{cards:[{summary:"Leitlinienempfehlungen zur Verbesserung der Gehfähigkeit",indicator:"info",detail:"Basierend auf der aktuellen Situation (Schlaganfall, Gangstörung) schlägt die Leitlinie folgende Maßnahmen vor. Bitte wählen Sie geeignete Empfehlungen für den weiteren Therapieplan aus.",source:{label:"Leitlinie Schlaganfallrehabilitation",url:"https://deine-leitlinie.org/rehabilitation-schlaganfall"},selectionBehavior:"single",suggestions:n.map((e=>{let t=e.strength.toUpperCase();return{label:e.heading,uuid:`recommendation-${o(e.recommendationId)}`,actions:["..."],title:e.heading,description:e.text,strength:{code:t,text:a[t]||e.strength}}}))}]}}),i}displayRecommendationsRadioCards(e){let t=e.entry.map((e=>e.resource)),n=document.getElementById("modalRecommendationsContainer");n.innerHTML=`\n      <div class="mb-2 text-info">\n        Über das integrierte Clinical Decision Support System (CDSS) wurden <strong>${t.length}</strong> Interventionen für das gewählte Ziel gefunden.\n      </div>\n      ${t.map(((e,t)=>{let{text:n,badge:o}={STRONG:{text:"Starke Empfehlung",badge:"bg-success"},WEAK:{text:"Schwache Empfehlung",badge:"bg-warning"},WEAKAGAINST:{text:"Schwache Empfehlung gegen",badge:"bg-danger"}}[e.strength.toUpperCase()]||{text:e.strength,badge:"bg-secondary"};return`\n          <div class="card mb-2" data-index="${t}" style="cursor: pointer;">\n            <div class="card-body">\n              <h6><b>${e.title}</b><br><span class="badge ${o}" style="font-size:0.8rem; margin-left:10px;">${n}</span></h6>\n              <p style="font-size:.9rem;color: grey">${e.description}</p>\n            </div>\n          </div>\n        `})).join("")}\n    `,n.querySelectorAll(".card").forEach((t=>{t.addEventListener("click",(()=>{n.querySelectorAll(".card").forEach((e=>e.classList.remove("active"))),t.classList.add("active");let o=t.getAttribute("data-index"),i=e.entry[o].resource;this.currentRecommendation=i,logToConsole("FHIR PlanDefintion Selected",i),document.getElementById("modalPlanForm").classList.remove("d-none"),document.getElementById("btnConfirmGuideline").disabled=!1}))}))}handleGuidelineFormSubmit(){if(!this.currentRecommendation)return void logToConsole("Fehler",{message:"Es wurde keine Intervention ausgewählt."});let e=document.getElementById("freqInputModal").value||"2",t=document.getElementById("durInputModal").value||"30";this.currentGoal.intervention={heading:this.currentRecommendation.title,frequency:e,duration:t};let n=this.createProcedure(e,t);this.goalProcedures.push({goalId:this.currentGoal.id,procedure:n}),this.renderGoalList(),this.guidelineModal.hide(),new bootstrap.Toast(document.getElementById("interventionToast")).show()}createProcedure(e,t){if(!this.currentRecommendation)return void logToConsole("Procedure Error",{message:"Es wurde keine Intervention ausgewählt."});let n={resourceType:"Procedure",id:`procedure-${Date.now()}`,status:"preparation",subject:{reference:"urn:uuid:patient-example"},code:{coding:[{system:"http://snomed.info/sct",code:"NA",display:"Bedarf noch einer Codierung!"}]},note:[{text:`${this.currentRecommendation.title} – ${this.currentRecommendation.description}`}],performedPeriod:{start:(new Date).toISOString()},occurrenceTiming:{repeat:{frequency:parseInt(e,10),period:1,periodUnit:"wk",duration:parseInt(t,10),durationUnit:"min"}},reasonReference:[{reference:`Goal/${this.currentGoal.id}`}]};return logToConsole("Procedure (Therapieplanung)",n),n}handlePlanComplete(){document.getElementById("btn-open-goal-modal").style.display="none",document.getElementById("btn-complete-planning").style.display="none";let e=document.getElementById("goals-info");e.textContent="Planung abgeschlossen",e.style.color="green",logToConsole("FHIR CarePlan",{resourceType:"CarePlan",id:`careplan-${Date.now()}`,status:"active",intent:"plan",subject:{reference:"urn:uuid:patient-example"},goal:this.addedGoals.map((e=>({reference:`Goal/${e.id}`}))),activity:this.goalProcedures.map((e=>({detail:e.procedure}))).concat([{detail:{resourceType:"Procedure",id:"procedure-74914000",status:"preparation",subject:{reference:"urn:uuid:patient-example"},code:{coding:[{system:"http://snomed.info/sct",code:"74914000",display:"Gait re-education"}]}}}])}),new bootstrap.Toast(document.getElementById("completePlanningToast")).show()}checkScreenSize(){document.getElementById("screen-warning").style.display=window.innerWidth<800||window.innerHeight<600?"flex":"none"}}document.addEventListener("DOMContentLoaded",(()=>{(new TherapyPlanApp).init()}));</script>